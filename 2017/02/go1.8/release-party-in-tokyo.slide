Hot-deploying in Go

Go 1.8 Release Party in Tokyo
16 Feb 2017
Tags: golang, graceful, hot-deploy

Masaki ISHIYAMA
Mercari, Inc
# b4b4r07 gmail.com
http://tellme.tokyo/
@b4b4r07

* Profile

.image img/icon.jpg 200 _

- [[https://github.com/b4b4r07][*@b4b4r07*]], a.k.a. BABAROT
- *'15/4*: Go ã§ CLI ãƒ„ãƒ¼ãƒ«ãªã©ã‚’æ›¸ãã¯ã˜ã‚ã‚‹
- *'16/4*: æ–°å’ä¸€æœŸã¨ã—ã¦ãƒ¡ãƒ«ã‚«ãƒªã«ã‚¸ãƒ§ã‚¤ãƒ³
-          ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ (PHP)
- *'16/8*: SRE ç ”ä¿® (1ãƒ¶æœˆ) ã«ã¦ API Gateway ã‚’æ›¸ã (Go)

* Softwares in Go

CLI ãƒ„ãƒ¼ãƒ«ãªã©ï¼

- [[https://github.com/b4b4r07/zsh-history][zsh-history]] - A plugin for zsh history extended by golang, dealing it like SQL
- [[https://github.com/b4b4r07/gomi][gomi]] - A simple trash tool that works on CLI, written in golang
- [[https://github.com/b4b4r07/twistd][twistd]] - Twitter Streaming daemon
- [[https://github.com/search?utf8=%E2%9C%93&q=user%3Ab4b4r07+language%3Ago+-bot&type=Repositories&ref=searchresults][*-bot]] - Slack bot
- etc...

ãƒ–ãƒ­ã‚°ãªã©ã‚‚æ›¸ã„ã¦ã‚‹ã®ã§ã‚ˆã‹ã£ãŸã‚‰è¦‹ã¦ã¿ã¦ãã ã•ã„ï¼

* Hot-deploying in Go - ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ã®å®Ÿä¾‹

* Timeline

- SRE ç ”ä¿®ï¼Œãƒ¡ãƒ³ã‚¿ãƒ¼ [[https://github.com/kazeburo][@kazeburo]] ã•ã‚“
- ç ”ä¿®ã®ä¸­ç›¤ã”ã‚ã‹ã‚‰ Go è£½ã® API Gateway ã‚’è§¦ã‚‹
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã®äºŒæ­©æ‰‹å‰ (ã“ã®ã¨ãã¯ï¼Œ[[https://revel.github.io/][Revel]] ã‚’ä½¿ç”¨)
- æœ¬æ ¼ç¨¼åƒã«å‘ã‘ã¦ãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œã•ã›ãŸã„
- [[https://github.com/lestrrat/go-server-starter][lestrrat/go-server-starter]] ã‚’ä½¿ã†
- ã¤ã„ã§ã« WAF ã‚’ä½¿ã‚ãšã« `net/http` ã§æ›¸ãç›´ã™
- Go 1.8 ã§ Graceful shutdown ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ ([[https://github.com/golang/go/issues/4674][#4674]])

* Dolphin

* Dolphin

Dolphin (API Gateway) ã¨ã¯ï¼Œ

- ä¾¿å®œä¸Šï¼Œã‚¤ãƒ«ã‚«ã¨å‘¼ã¶ğŸ¬
- Revel ã§æ›¸ã‹ã‚Œã¦ã„ãŸ
- åˆ¥ã®æ–°å’ (åŒæ§˜ã« SRE ç ”ä¿®) ã«ã‚ˆã£ã¦ã¤ãã‚‰ã‚ŒãŸ
- ãã®ã¾ã¾å¼•ãç¶™ãï¼ŒBASIC èªè¨¼æ©Ÿèƒ½ã‚„ã‚¯ã‚¨ãƒªã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’åŠ ãˆãŸ
- ãã—ã¦ï¼Œãƒ‡ãƒ—ãƒ­ã‚¤ ... ğŸš€
- ã‚ãŸã‚‰ã—ã„æ©Ÿèƒ½ P-R ã—ãŸã‘ã©ï¼Œã‚¢ãƒ¬...

(Revel ã£ã¦ Graceful shutdown ã§ãã‚‹ã®...?)

* Dolphin

Revel...

- [[https://github.com/revel/revel/pull/690][Support zero downtime restarts #690]]
- [[https://github.com/revel/revel/pull/765][Revert "Support zero downtime restarts" #765]]

(ä»Šã¨ãªã£ã¦ã¯ã§ãã‚‹ã‚ˆã†)

* Dolphin

ã¾ãšï¼Œ

- ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã® API ã‹ã‚‰å‘¼ã°ã‚Œã‚‹é–¢ä¿‚ä¸Šï¼Œãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„
- è¦ä»¶çš„ã« Revel ã»ã©é«˜æ©Ÿèƒ½ãª WAF ã¯å¿…è¦ãªã‹ã£ãŸ
- `net/http` ã§åŒæ©Ÿèƒ½ã®ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œã£ã¦ãƒ™ãƒ³ãƒã‚’å–ã£ãŸã‚‰å€ã«ãªã£ã¦ãŸ

ä»¥ä¸‹ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ: (ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã§è¨ˆæ¸¬)

    $ ab -n 10000 -c 1

.image img/benchmark.png 150 _

ã‚ã¨ã¯ï¼Œãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œ...

* Hot-deploying

* Hot-deploying

# Hot-deployable services are those which can be added to or removed from the running server.
# It is the ability to change ON-THE-FLY what's currently deployed without redeploying it.

ãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã¯ï¼Œ

- fmfm

* lestrrat/go-server-starter

* lestrrat/go-server-starter

ã‚¤ãƒ«ã‚«ã•ã‚“ï¼Œå¯¾å¿œã—ãŸ ğŸ¬

.image img/kazeburo.png 450 _

* Go graceful shutdown

* BTW,

ãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œã®ã¤ã„ã§ã« WAF ã‚’ã‚„ã‚ãŸè©±ã¯ä»¥ä¸‹ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ï¼

.image img/blog.png 400 _

[[http://tech.mercari.com/entry/2016/12/19/180000][http://tech.mercari.com/entry/2016/12/19/180000]]

* ã¾ã¨ã‚
