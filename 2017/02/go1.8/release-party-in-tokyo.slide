Hot-deploying in Go

Go 1.8 Release Party in Tokyo
16 Feb 2017
#Tags: golang, graceful, hot-deploy

Masaki ISHIYAMA
Mercari, Inc
# b4b4r07 gmail.com
http://tellme.tokyo/
@b4b4r07

* Profile

.image img/icon.jpg 200 _

- [[https://github.com/b4b4r07][*@b4b4r07*]], a.k.a. BABAROT
- *'15/4*: Go ã§ CLI ãƒ„ãƒ¼ãƒ«ãªã©ã‚’æ›¸ãã¯ã˜ã‚ã‚‹
- *'16/4*: æ–°å’ä¸€æœŸã¨ã—ã¦ãƒ¡ãƒ«ã‚«ãƒªã«ã‚¸ãƒ§ã‚¤ãƒ³
-          ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ (PHP)
- *'16/8*: SRE ç ”ä¿® (1ãƒ¶æœˆ) ã«ã¦ API Gateway ã‚’æ›¸ã (Go)

* Softwares in Go

CLI ãƒ„ãƒ¼ãƒ«ãªã©ï¼

- [[https://github.com/b4b4r07/zsh-history][zsh-history]] - A plugin for zsh history extended by golang, dealing it like SQL
- [[https://github.com/b4b4r07/gomi][gomi]] - A simple trash tool that works on CLI, written in golang
- [[https://github.com/b4b4r07/twistd][twistd]] - Twitter Streaming daemon
- [[https://github.com/search?utf8=%E2%9C%93&q=user%3Ab4b4r07+language%3Ago+-bot&type=Repositories&ref=searchresults][*-bot]] - Slack bot
- etc...

ãƒ–ãƒ­ã‚°ãªã©ã‚‚æ›¸ã„ã¦ã‚‹ã®ã§ã‚ˆã‹ã£ãŸã‚‰è¦‹ã¦ã¿ã¦ãã ã•ã„ï¼

ğŸ†• [[http://www.tellme.tokyo/entry/2017/02/14/214231][golang ã§ zsh history ã‚’ SQL çš„ã«æ´»ç”¨ã™ã‚‹ - tellme.tokyo]]

* Hot-deploying in Go - ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ã®å®Ÿä¾‹

* Timeline

- SRE ç ”ä¿®ï¼Œãƒ¡ãƒ³ã‚¿ãƒ¼ [[https://github.com/kazeburo][@kazeburo]] ã•ã‚“
- ç ”ä¿®ã®ä¸­ç›¤ã”ã‚ã‹ã‚‰ Go è£½ã® API Gateway ã‚’è§¦ã‚‹
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã®äºŒæ­©æ‰‹å‰ (ã“ã®ã¨ãã¯ï¼Œ[[https://revel.github.io/][Revel]] ã‚’ä½¿ç”¨)
- æœ¬æ ¼ç¨¼åƒã«å‘ã‘ã¦ãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œã•ã›ãŸã„
- [[https://github.com/lestrrat/go-server-starter][lestrrat/go-server-starter]] ã‚’ä½¿ã†
- ã¤ã„ã§ã« WAF ã‚’ä½¿ã‚ãšã« `net/http` ã§æ›¸ãç›´ã™
- Go 1.8 ã§ Graceful shutdown ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ ([[https://github.com/golang/go/issues/4674][#4674]])

* Dolphin

* Dolphin

Dolphin (API Gateway) ã¨ã¯ï¼Œ

- ä¾¿å®œä¸Šï¼Œã‚¤ãƒ«ã‚«ã¨å‘¼ã¶ğŸ¬
- Revel ã§æ›¸ã‹ã‚Œã¦ã„ãŸ
- åˆ¥ã®æ–°å’ (åŒæ§˜ã« SRE ç ”ä¿®) ã«ã‚ˆã£ã¦ã¤ãã‚‰ã‚ŒãŸ
- ãã®ã¾ã¾å¼•ãç¶™ãï¼ŒBASIC èªè¨¼æ©Ÿèƒ½ã‚„ã‚¯ã‚¨ãƒªã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’åŠ ãˆãŸ
- ãã—ã¦ï¼Œãƒ‡ãƒ—ãƒ­ã‚¤ ... ğŸš€
- ã‚ãŸã‚‰ã—ã„æ©Ÿèƒ½ P-R ã—ãŸã‘ã©ï¼Œã‚¢ãƒ¬...

(Revel ã£ã¦ Graceful restart ã§ãã‚‹ã®...?)

* Dolphin

Revel...

- [[https://github.com/revel/revel/pull/690][Support zero downtime restarts #690]]
- [[https://github.com/revel/revel/pull/765][Revert "Support zero downtime restarts" #765]]

(ä»Šã¨ãªã£ã¦ã¯ã§ãã‚‹ã‚ˆã†)

* Dolphin

ã¾ãšï¼Œ

- ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã® API ã‹ã‚‰å‘¼ã°ã‚Œã‚‹é–¢ä¿‚ä¸Šï¼Œãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„
- è¦ä»¶çš„ã« Revel ã»ã©é«˜æ©Ÿèƒ½ãª WAF ã¯å¿…è¦ãªã‹ã£ãŸ
- `net/http` ã§åŒæ©Ÿèƒ½ã®ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œã£ã¦ãƒ™ãƒ³ãƒã‚’å–ã£ãŸã‚‰å€ã«ãªã£ã¦ãŸ

ä»¥ä¸‹ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ: (ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã§è¨ˆæ¸¬)

    $ ab -n 10000 -c 1

.image img/benchmark.png 150 _

ã‚ã¨ã¯ï¼Œãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œ...

* Hot-deploying

* Hot-deploying

# Hot-deployable services are those which can be added to or removed from the running server.
# It is the ability to change ON-THE-FLY what's currently deployed without redeploying it.

ãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã¯ï¼Œ

- *ãƒ‡ãƒ—ãƒ­ã‚¤* - App ã®å¤‰æ›´ã‚’å„æœ¬ç•ªã‚µãƒ¼ãƒã«å±•é–‹ã™ã‚‹ã“ã¨
- é€šå¸¸ã¯ã‚µãƒ¼ãƒã®åœæ­¢ã¨å†èµ·å‹•ã‚’ã¨ã‚‚ãªã†
- ãã®é–“ï¼Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–ã‚Šã“ã¼ã—ã¦ã—ã¾ã†
- ãƒªãƒ­ãƒ¼ãƒ‰ã®ã¿ã§å¤‰æ›´ã‚’å–ã‚Šè¾¼ã‚€æŠ€è¡“ï¼Œãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•
- => ã„ã‚ã‚†ã‚‹ã“ã‚Œã‚’ *ãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤* ã¨ã„ã†
- ã¤ã¾ã‚Šï¼Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã‚’ç¶šã‘ãªãŒã‚‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å…¥ã‚Œæ›¿ãˆãŒå¯èƒ½

* Hot-deploying

æœ‰åãªã‚‚ã®ã« `Server::Starter` ([[https://github.com/kazuho/p5-Server-Starter][kazuho/p5-Server-Starter]])

    $ start_server --port=8080 --pid-file=app.pid -- ./dolphin

- `port`: ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ãƒãƒ¼ãƒˆ
- `pid-file`: start_server ã® PID

    $ ab -n 10000 -c 100 http://127.0.0.1:8080/

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹

    $ kill -HUP $(cat app.pid)

HUP ã‚·ã‚°ãƒŠãƒ«ã‚’é€ã‚‹ã¨ãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹

ãŸã ã—ï¼Œ `start_server` ã‚’ä½¿ã£ã¦ãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ï¼Œ
`Server::Starter` ã«å¯¾å¿œã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹

* Hot-deploying

ä»•çµ„ã¿ï¼Œ

- App ã‚µãƒ¼ãƒèµ·å‹•
- ä¸Šä½ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚½ã‚±ãƒƒãƒˆã‚’ç”Ÿæˆ
- ã‚½ã‚±ãƒƒãƒˆã‚’å…±æœ‰ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ fork ã— HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®å­ãƒ—ãƒ­ã‚»ã‚¹ã‚’ fork
- å¤‰æ›´ç‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ (ãƒã‚¤ãƒŠãƒªã®å…¥ã‚Œæ›¿ãˆ) ã—ã¦ HUP ã‚·ã‚°ãƒŠãƒ«ã‚’é€ä¿¡ã™ã‚‹
- ã‚·ã‚°ãƒŠãƒ«ã‚’å—ã‘å–ã£ãŸã‚µãƒ¼ãƒã¯ãã®ã‚½ã‚±ãƒƒãƒˆã‚’å…±æœ‰ã™ã‚‹åˆ¥ã®ãƒ—ãƒ­ã‚»ã‚¹éƒ¡ã‚’ fork ã™ã‚‹ï¼ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒæ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’åæ˜ ã—ãŸãƒ—ãƒ­ã‚»ã‚¹ã§ï¼ŒHTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¦ã„ã
- å¤ã„ã¾ã¾ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ­¢ã‚ã‚‹ãŸã‚ã«ã‚·ã‚°ãƒŠãƒ«ã‚’é€ã‚‹
- å¤ã„ãƒ—ãƒ­ã‚»ã‚¹ãŒ (graceful ã«) çµ‚äº†ã™ã‚‹

* Hot-deploying

.image img/fork.png 500 _

.caption [[http://blog.shibayu36.org/entry/2012/05/07/201556][Server::Starterã‹ã‚‰å­¦ã¶hot deployã®ä»•çµ„ã¿]]

* lestrrat/go-server-starter

* lestrrat/go-server-starter

[[https://github.com/lestrrat/go-server-starter][lestrrat/go-server-starter]]

- `Server::Starter` ã® Go ç§»æ¤ç‰ˆ (ãƒ©ã‚¤ãƒ–ãƒ©ãƒª)
- Go å®Ÿè£…ã® `start_server` ã‚³ãƒãƒ³ãƒ‰ã‚‚åŒæ¢±

.image img/starter.png 350 _

* lestrrat/go-server-starter

ã¾ãšã¯ï¼Œ `start_server` ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

    $ go get github.com/lestrrat/go-server-starter/cmd/start_server

ã‚ã¨ã¯ go-server-starter ã«å¯¾å¿œã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã„ã¦ã„ãï¼

* lestrrat/go-server-starter

    import "github.com/lestrrat/go-server-starter/listener"

æŒ‡å®šãƒãƒ¼ãƒˆã§ `[]net.Listener` ã‚’é †ã€…ã«ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã

ä»¥ä¸‹ï¼ŒApp å´ã®ã‚³ãƒ¼ãƒ‰ (ã‚¹ãƒšãƒ¼ã‚¹ä¸Šï¼Œerr å‡¦ç†çœç•¥)

_dolphin.go_

#.code src/server.go /^	if/,/^		l,/

.code src/server-1.go

* lestrrat/go-server-starter

ç’°å¢ƒå¤‰æ•° `SERVER_STARTER_PORT` ã«ãƒãƒ¼ãƒˆã¨ FD ãŒå…¥ã£ã¦ã„ã‚‹

`port=fd;port=fd` å½¢å¼

    $ echo $SERVER_STARTER_PORT
    8080=3

ä»¥ä¸‹ï¼Œã‚„ã£ã¦ã‚‹ã“ã¨:

_go-server-starter/listener/listener.go_

- `SERVER_STARTER_PORT` ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ port ã¨ fd ã«åˆ†ã‘ã‚‹
- ä¸Šä½ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰æ¸¡ã£ã¦ããŸ fd ã§ `os.NewFile` ãŒ `*File` ã‚’ä½œã‚‹
- ãã® `*File` ã‚’ `net.FileListener` ã§ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹

* lestrrat/go-server-starter

ã‚¤ãƒ«ã‚«ã•ã‚“ï¼Œå¯¾å¿œã—ãŸ ğŸ¬

.image img/kazeburo.png 400 _

listener ã‚’çµ„ã¿è¾¼ã‚“ã§ï¼Œ `start_server` ã§èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹

* BTW,

ãƒ›ãƒƒãƒˆãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œã®ã¤ã„ã§ã« WAF ã‚’ã‚„ã‚ãŸè©±ã¯ä»¥ä¸‹ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ï¼

.image img/blog.png 400 _

.caption [[http://tech.mercari.com/entry/2016/12/19/180000][http://tech.mercari.com/entry/2016/12/19/180000]]

* Go graceful shutdown

* Go graceful shutdown

# go-server-starter ã ã‘ã§ã¯ Graceful shutdown ã‚’å®Ÿç¾ã§ããªã„ï¼

ã“ã“ã§ã„ã† Graceful shutdown ã¨ã¯ï¼Œ

HTTP ã‚µãƒ¼ãƒã«ãŠã„ã¦ï¼Œ
å¼µã‚‰ã‚ŒãŸã‚½ã‚±ãƒƒãƒˆã‚’ã„ããªã‚Šåˆ‡ã£ã¦ã‚µãƒ¼ãƒã‚’çµ‚äº†ã™ã‚‹ã®ã§ã¯ãªã
ã™ã§ã« accept ã•ã‚Œã¦ã„ã‚‹ã‚½ã‚±ãƒƒãƒˆã«å¯¾ã™ã‚‹å‡¦ç†ã‚’çµ‚ãˆã¦ã‹ã‚‰çµ‚äº†ã™ã‚‹ã“ã¨

# _åœæ­¢ãŒæŒ‡ç¤ºã•ã‚Œã¦ä»¥é™ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ–°ãŸãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å—ã‘ä»˜ã‘ãšï¼Œ_
# _ãŸã ã—å—ä¿¡æ¸ˆã¿ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã¯å®Œäº†ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—çµ‚äº†ã™ã‚‹æ©Ÿèƒ½_

* Go graceful shutdown

*~* *Go* *1.7* ã¾ã§ï¼

Graceful ã®æ©Ÿèƒ½ã ã‘ã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£

- [[https://github.com/braintree/manners][braintree/manners]]
- [[https://github.com/tylerb/graceful][tylerb/graceful]]
- [[https://github.com/shogo82148/go-gracedown][shogo82148/go-gracedown]]
- etc...

Go 1.3 ã® [[http://golang-jp.org/pkg/net/http/#ConnState][ConnState]] ã‚’ä½¿ã£ã¦å®Ÿç¾ã—ã¦ã„ã‚‹æ¨¡æ§˜

go-gracedown ã¯æ—§æ¥ã® I/F ã‹ã‚‰ Go 1.8 ã®å®Ÿè£…ã‚’ä½¿ã†ã‚‰ã—ã„ï¼

ã‚‚ã—ãã¯ 1.7 ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ã¯ãã®ã¾ã¾åˆ©ç”¨ã§ãã‚‹

.caption [[https://twitter.com/shogo82148/status/810852586697801728][https://twitter.com/shogo82148/status/810852586697801728]]

* Go graceful shutdown

*Go* *1.8*

`net/http`

- `Server.Close`
- `Server.Shutdown` (Graceful)

æ¨™æº–æ©Ÿèƒ½ã¨ã„ã†å¼·ã¿

æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’ã¡ã‚‡ã£ã¨æ›¸ãæ›ãˆã‚‹ã ã‘ã§å¯¾å¿œã™ã‚‹ã“ã¨ãŒã§ãã‚‹

    func (srv *Server) Shutdown(ctx context.Context) error

* Go graceful shutdown

æ‰‹ã‚’å…¥ã‚Œã‚‹ç®‡æ‰€ã¨ã—ã¦ã¯ãã‚“ãªã«å¤šããªã„

.code src/graceful.go /^	server/,/^}/

* Go graceful shutdown

å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ï¼Œ

`Server.Shutdown` ã¨ go-server-starter ã‚’åˆ©ç”¨ã™ã‚‹ãƒ‘ãƒƒãƒ

- [[https://github.com/mercari/gaurun/pull/57][Support graceful shutdown and hot-deploying #57]]
- [[https://github.com/mercari/widebullet/pull/10][Support hot-deploying (with graceful shutdown) #10]]

* Go graceful shutdown

è‡ªåˆ†ã§ã‚‚ãƒŸãƒ‹ãƒãƒ«ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆæ›¸ã„ã¦ãƒ™ãƒ³ãƒå–ã£ã¦ã¿ãŸï¼

    $ start_server --port=8080 --pid-file=/tmp/app.pid -- ./server
    --
    $ while :; do kill -HUP $(cat /tmp/app.pid); sleep 1; done
    --
    $ ab -n 10000 -c 100 http://127.0.0.1:8080/

çµæœï¼Œ

    Complete requests:      10000
    Failed requests:        0

ğŸ¤”

* Go graceful shutdown

Go è£½ HTTP load ãƒ„ãƒ¼ãƒ« [[https://github.com/rakyll/hey][rakyll/hey]]ï¼Œ

# ab ã‚’ãƒªãƒ—ãƒ¬ãƒ¼ã‚¹ã—ãŸ CLI ãªã®ã§é¦´æŸ“ã¿ã‚„ã™ã„

    $ start_server --port=8080 --pid-file=/tmp/app.pid -- ./server
    --
    $ kill -TERM $(cat /tmp/app.pid)
    --
    $ hey -n 3000 -c 100 http://localhost:8000

çµæœï¼Œ

    Summary:
      Total:        13.6336 secs
      Slowest:      0.1093 secs
      Fastest:      0.1004 secs
      Average:      0.1049 secs
      Requests/sec: 168.7006
    Status code distribution:
      [200] 2300 responses
    Error distribution:
      [700]        Get http://localhost:8000: dial tcp [::1]:8000: getsockopt: connection refused

æ–°è¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ãªã„ï¼Œãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹ã¶ã‚“ã¯æŒã

* Summary

* Summary

- Go 1.8 ãƒªãƒªãƒ¼ã‚¹ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰
- å½“åˆ Revel ã§å®Ÿè£…ã•ã‚Œã¦ã„ãŸ API ã‚’ `net/http` ãƒ™ãƒ¼ã‚¹ã§å†å®Ÿè£…ã—ã¾ã—ãŸ
- ä½•ã‚‰ã‹ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§å®Ÿè£…ã™ã‚‹ã®ã‚‚ã„ã„ã¨æ€ã„ã¾ã™ãŒï¼Œ `net/http` ã ã‘ã§ã‚‚ååˆ†ã ã‚ˆã­ï¼Œã¨è¦‹åˆ‡ã‚ŠãŒã¤ã„ãŸæ™‚ç‚¹ã§èˆµã‚’åˆ‡ã‚‹ã®ã¯ã„ã„ã“ã¨ã ã¨æ€ã„ã¾ã™
- `go-server-starter` ä¾¿åˆ©ã§ã™ã­
- Go 1.8 Graceful shutdown ã‚‚ç°¡å˜ã«å°å…¥ã§ããã†ãªæ„Ÿã˜ã§ã™
- ã¾ã™ã¾ã™ï¼ŒGo ãŒæ°—ã«ãªã£ã¦ã„ã¾ã™ï¼ã“ã‚Œã‹ã‚‰ã‚‚æ›¸ã„ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ ğŸ’ª
